{% import os,socket,glob %}


<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="shortcut icon" href="{{static_url('favicon.ico')}}">
	
	<title data-l10n-id="title"></title>
	
	<script src="{{static_url('pep.js')}}"></script>
	<script src="{{static_url('jquery.js')}}"></script>
	<script src="{{static_url('bootstrap.js')}}"></script>
	<link rel="stylesheet" href="{{static_url('bootstrap.css')}}">
	<link rel="stylesheet" href="{{static_url('font-awesome/css/font-awesome.min.css')}}">
	
	<script src="{{static_url('knockout.js') }}"></script>
	<script src="{{static_url('knockout.mapping.js') }}"></script>
	<script src="{{static_url('pager.js') }}"></script>

	{% block head %}{% end %}
	
	<script defer src="{{static_url('l20n.js')}}"></script>
	<link rel="localization" href="{{ajax_url('locale/{locale}.ftl')}}">
	<meta name="defaultLanguage" content="en">
	<meta name="availableLanguages" content="{{','.join(sorted(os.path.splitext(os.path.basename(f))[0] for f in glob.glob('locale/*.ftl')))}}">
</head>


<script>
var hosts = {
	mc:		'{{ socket.gethostbyname('mc') }}'
}

function ajaxUrl(url, params=null) {
	return '{{ajax_url()}}'+url + (params ? '?'+$.param(params) : '');
}
function wsUrl(host, port, url=null, params=null) {
	return 'ws://' + (host ? (host in hosts ? hosts[host] : host)+':'+port : (port ? location.hostname+':'+port : location.host)) + (url ? ajaxUrl(url, params) : '/');
}

function requestFullscreen() {
	(document.documentElement.requestFullScreen || document.documentElement.webkitRequestFullScreen || document.documentElement.mozRequestFullScreen || document.documentElement.msRequestFullScreen).call(document.documentElement);
}

function GuiPage(pageModel, pageParams, pageGuard, pageRoute) {
	let self = this;
	
	self.params = pageParams();
	
	self.create = function(callback) {
		self.model = pageModel();
		callback(self.model);
	}
	
	self.start = function() {
		if (self.model && self.model.start) self.model.start();
	}
	self.stop = function() {
		if (self.model && self.model.stop) self.model.stop();
	}
	
	self.guard = function(page, route, callback) {
		if (pageGuard())
			callback();
		else
			pager.navigate(page.currentParentPage() ? page.currentParentPage().path() : page.parentPage.path());
	}
	
	self.route = function(event) {
		let route = pageRoute();
		if (route)
			pager.navigate(event.page.path()+'/'+route);
	}
}

gui = new function() {
	let self = this;

	self.state		= ko.observable(null);
	self.isState	= function(state) {
		return self.state() && (state in self.state()) && self.state()[state]();
	}
}

{% block script %}{% end %}

</script>


<body data-bind="visible:true" style="display:none">
	
	{% block html %}{% end %}
	
	<div id="stateDisconnected" data-backdrop="static" data-keyboard="false" class="modal">
		<div class="modal-dialog modal-lg">
			<div class="alert alert-warning">
				<p data-l10n-id="disconnected"></p>
			</div>
		</div>
	</div>
</body>


<script>(function(){

let stateWatchdog;
let stateConnection;
let stateDisconnected	= false;

function updateState(msg) {
	if (msg) {
		if (!gui.state())
			gui.state(ko.mapping.fromJS(msg));
		else
			ko.mapping.fromJS(msg, gui.state());
	} else {
		gui.state(null);
	}
	
	pager.goTo(pager.activePage$().path());
}

function resetWatchdog() {
	clearTimeout(stateWatchdog);
	stateWatchdog = setTimeout(function(){
		console.log('ERROR: lost connection -> reconnecting...');
		try {
			stateConnection.close();
		} catch(e) {}
		updateState();
		reconnectState();
	}, 5000+1000);
}

function reconnectState() {
	resetWatchdog();

	stateConnection = new WebSocket(wsUrl(null, null, 'state'));
	
	stateConnection.onopen = function() {
		if (stateDisconnected)
			location.reload();
	}
	
	stateConnection.onerror = function() {
		$('#stateDisconnected').modal();
		stateDisconnected = true;
	}
	
	stateConnection.onmessage = function (e) {
		let msg = JSON.parse(e.data);

		if (!$.isEmptyObject(msg))
			updateState(msg);

		resetWatchdog();
	}
}

reconnectState();

pager.extendWithPage(gui);
ko.applyBindings(gui);
pager.start();

})();</script>

</html>
