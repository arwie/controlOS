{% extends "page.html" %}


{% block html %}
<div class="row">
	
	<div class="col-md-2">
		<div data-bind="foreach: sections" class="list-group">
			<label class="list-group-item">
				<span data-bind="text: name"></span>
				<input type="checkbox" data-bind="checked: show" class="pull-right">
			</label>
		</div>
	</div>
	
	<div class="col">
		<table data-bind="foreach: {data: sections, as: 'section'}" class="table table-sm table-hover">
			<tbody data-bind="foreach: {data: keys(), as: 'key'}, visible: section.show">
				<tr>
					<th class="col-md-2" data-bind="text: section.name"></th>
					<td class="col-md-3" data-bind="text: key"></td>
					<td class="col" data-bind="text: section.value(key)"></td>
				</tr>
			</tbody>
		</table>
	</div>
	
</div>
{% end %}


{% block script %}
function DebugSection(name, values) {
	let self = this;

	self.name	= name;
	self.values	= ko.observable(values);
	self.show	= ko.observable(true);
	
	self.keys	= function() {
		return Object.keys(self.values());
	};
	
	self.value	= function(key) {
		return ko.pureComputed(function() {
			let value = self.values()[key];
			return typeof value == 'object' ? JSON.stringify(value, null, 2) : value;
		});
	}
}
{% end %}


{% block model %}
function() {
	let self = this;
	
	self.sections = ko.observableArray();
	
	self.start = function()
	{
		self.ws = new WebSocket('ws://'+hosts.mc+':5610');
		
		self.ws.onmessage = function (e) {
			let msg = JSON.parse(e.data);
			
			if (!self.sections().length) {
				Object.keys(msg).forEach(function (key) {
					self.sections.push(new DebugSection(key, msg[key]));
				});
			}
			
			self.sections().forEach(function (section) {
				section.values(msg[section.name]);
			});
		}
	}
	
	self.stop = function() {
		self.ws.close();
	}
}
{% end %}


{% block guard %}
	return gui.isState('debug');
{% end %}
