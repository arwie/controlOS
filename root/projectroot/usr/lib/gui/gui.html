<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="/static/favicon.ico">
	
	<title data-l10n-id="title"></title>
	
	<script src="/static/pep.js"></script>
	<script src="/static/jquery.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
		
	<script src="/static/knockout.js"></script>
	<script src="/static/knockout.mapping.js"></script>
	<script src="/static/pager.js"></script>

	<script src="/static/three.js/three.min.js"></script>
	<script src="/static/three.js/STLLoader.js"></script>
	<script src="/static/three.js/TrackballControls.js"></script>
	
	<script defer src="/static/l20n.js"></script>
	<link rel="localization" href="locale/{locale}.ftl">
	<meta name="availableLanguages" content="en,de">
	<meta name="defaultLanguage" content="en">	
</head>
<script>
gui = new function() {
	let self = this;

	self.state				= ko.observable(null);
	self.stateWatchdog;
	self.stateConnection;
	self.stateDisconnected	= false;
	
	self.isState	= function(state) {
		return self.state() && (state in self.state()) && self.state()[state]();
	}
	
	self.stateGuard	= function(state) { return function(page, route, callback) {
		if (self.isState(state))
			callback();
		else
			pager.navigate(page.currentParentPage() ? page.currentParentPage().path() : page.parentPage.path());
	}}
}

$(document).ready(function()
{
	pager.extendWithPage(gui);
	ko.applyBindings(gui);
	pager.start();
	
	function updateState(msg) {
		if (msg) {
			if (!gui.state())
				gui.state(ko.mapping.fromJS(msg));
			else
				ko.mapping.fromJS(msg, gui.state());
		} else {
			gui.state(null);
		}
		
		pager.goTo(pager.activePage$().path());
	}
	
	function reconnectState() {
		resetWatchdog();

		gui.stateConnection = new WebSocket('ws://'+location.hostname+'/mc/state');
		
		gui.stateConnection.onopen = function() {
			if (gui.stateDisconnected)
				location.reload();
		}
		
		gui.stateConnection.onerror = function() {
			$('#stateDisconnected').modal();
			gui.stateDisconnected = true;
		}
		
		gui.stateConnection.onmessage = function (e) {
			let msg = JSON.parse(e.data, function(k, v) { return (typeof v === "object" || isNaN(v)) ? v : parseInt(v); });

			if (!$.isEmptyObject(msg))
				updateState(msg);

			resetWatchdog();
		}
	}
	
	function resetWatchdog() {
		clearTimeout(gui.stateWatchdog);
		gui.stateWatchdog = setTimeout(function(){
			console.log('ERROR: lost connection -> reconnecting...');
			try {
				gui.stateConnection.close();
			} catch(e) {}
			updateState();
			reconnectState();
		}, 5000+1000);
	}
	
	reconnectState();
});

function requestFullscreen() {
	(document.documentElement.requestFullScreen || document.documentElement.webkitRequestFullScreen || document.documentElement.mozRequestFullScreen || document.documentElement.msRequestFullScreen).call(document.documentElement);
}
</script>
<body data-bind="visible: true" style="display: none">
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a onclick="requestFullscreen()" class="navbar-brand" data-l10n-id="title"></a>
			</div>
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav">
					{% include "app/menu.html" %}
				</ul>
				<ul class="nav navbar-nav navbar-right">
					{% include "nav-diag.html" %}
					{% include "nav-studio.html" %}
					{% include "nav-admin.html" %}
					{% include "locale.html" %}
				</ul>
			</div>
		</div>
	</nav>
	<main class="container-fluid">
		{% include "app/app.html" %}
		
		{% include "log.html" %}
		{% include "debug.html" %}
		{% include "simio.html" %}
		{% include "update.html" %}
		{% include "remote.html" %}
		{% include "wlan.html" %}
		{% include "backup.html" %}
	</main>
	<div id="stateDisconnected" data-backdrop="static" data-keyboard="false" class="modal">
		<div class="modal-dialog modal-lg">
			<div class="alert alert-warning">
				<p data-l10n-id="disconnected"></p>
			</div>
		</div>
	</div>
</body>
</html>
